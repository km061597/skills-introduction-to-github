name: Deploy to Staging

on:
  push:
    branches:
      - main
      - 'claude/**'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  STAGING_URL: http://staging.smartamazon.local
  DEPLOYMENT_TIMEOUT: 300

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Docker Compose
        run: |
          docker-compose config > /dev/null
          echo "‚úÖ Docker Compose configuration is valid"

      - name: Check for required files
        run: |
          required_files=(
            "backend/Dockerfile"
            "frontend/Dockerfile"
            "docker-compose.yml"
            "backend/requirements.txt"
            "frontend/package.json"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Required file missing: $file"
              exit 1
            fi
            echo "‚úÖ Found: $file"
          done

      - name: Validate environment files
        run: |
          if [ ! -f "backend/.env.example" ]; then
            echo "‚ùå backend/.env.example is missing"
            exit 1
          fi
          if [ ! -f "frontend/.env.example" ]; then
            echo "‚ùå frontend/.env.example is missing"
            exit 1
          fi
          echo "‚úÖ Environment example files present"

  build-images:
    name: Build Production Images
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend production image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: smartamazon-backend:staging
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Build frontend production image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: smartamazon-frontend:staging
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Test images startup
        run: |
          echo "Testing backend image..."
          docker run -d --name test-backend smartamazon-backend:staging
          sleep 5
          docker logs test-backend
          docker stop test-backend
          docker rm test-backend

          echo "Testing frontend image..."
          docker run -d --name test-frontend smartamazon-frontend:staging
          sleep 5
          docker logs test-frontend
          docker stop test-frontend
          docker rm test-frontend

          echo "‚úÖ All images start successfully"

  deploy-to-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: [build-images]
    environment:
      name: staging
      url: http://staging.smartamazon.local

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup staging environment
        run: |
          echo "Setting up staging environment..."
          mkdir -p staging-deployment
          cp docker-compose.yml staging-deployment/
          cp backend/.env.example backend/.env
          cp frontend/.env.example frontend/.env

      - name: Deploy with Docker Compose
        run: |
          echo "Deploying to staging environment..."
          docker-compose build
          docker-compose up -d
          echo "‚úÖ Services deployed"

      - name: Wait for services
        run: |
          echo "Waiting for services to become healthy..."
          timeout=60
          counter=0

          while [ $counter -lt $timeout ]; do
            if docker-compose ps | grep -q "Up"; then
              echo "‚úÖ Services are up"
              break
            fi
            echo "Waiting... ($counter/$timeout)"
            sleep 2
            counter=$((counter + 2))
          done

          if [ $counter -ge $timeout ]; then
            echo "‚ùå Timeout waiting for services"
            docker-compose ps
            docker-compose logs
            exit 1
          fi

      - name: Health check - Backend
        run: |
          echo "Checking backend health..."
          max_attempts=30
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:8000/health 2>/dev/null; then
              echo "‚úÖ Backend is healthy"
              response=$(curl -s http://localhost:8000/health)
              echo "Response: $response"
              break
            fi
            echo "Attempt $((attempt + 1))/$max_attempts..."
            sleep 2
            attempt=$((attempt + 1))
          done

          if [ $attempt -ge $max_attempts ]; then
            echo "‚ùå Backend health check failed"
            docker-compose logs backend
            exit 1
          fi

      - name: Health check - Frontend
        run: |
          echo "Checking frontend health..."
          max_attempts=30
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:3000 2>/dev/null; then
              echo "‚úÖ Frontend is accessible"
              break
            fi
            echo "Attempt $((attempt + 1))/$max_attempts..."
            sleep 2
            attempt=$((attempt + 1))
          done

          if [ $attempt -ge $max_attempts ]; then
            echo "‚ùå Frontend health check failed"
            docker-compose logs frontend
            exit 1
          fi

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."

          # Test API root
          echo "Testing API root..."
          curl -f http://localhost:8000/ || exit 1

          # Test API docs
          echo "Testing API documentation..."
          curl -f http://localhost:8000/api/docs || exit 1

          # Test frontend
          echo "Testing frontend..."
          curl -f http://localhost:3000 || exit 1

          echo "‚úÖ All smoke tests passed"

      - name: Deployment summary
        if: success()
        run: |
          echo "=========================================="
          echo "üéâ Deployment to Staging Successful!"
          echo "=========================================="
          echo ""
          echo "Services:"
          docker-compose ps
          echo ""
          echo "Backend: http://localhost:8000"
          echo "Frontend: http://localhost:3000"
          echo "API Docs: http://localhost:8000/api/docs"
          echo ""
          echo "‚úÖ All health checks passed"
          echo "‚úÖ All smoke tests passed"

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "Deployment failed, cleaning up..."
          docker-compose logs
          docker-compose down -v

      - name: Cleanup
        if: always()
        run: docker-compose down -v
